from openai import OpenAI
from token_logger import token_logger
from time_logger import timed

class DocumentAnalyzer:
    def __init__(self,
                 open_router_client: OpenAI,
                 generation_model: str,
                 ):
        self.open_router_client = open_router_client
        self.generation_model = generation_model

    @timed
    def generate_summary(self, user_prompt, document_text: str):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–º–º–∞—Ä–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∫—Ä–∞—Ç–∫–æ–π —Å—É—Ç—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–∏—Å–∫–∞–º–∏"""
        prompt = f"""–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å 15-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∑–∞—â–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ –µ–º–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.

–¢–≤–æ–π –æ—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–Ω—è—Ç–µ–Ω —á–µ–ª–æ–≤–µ–∫—É –±–µ–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è. –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–∫–∞–∑–∞—Ç—å –ø—É–Ω–∫—Ç—ã, –∞ –≤—Å–∫—Ä—ã—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ä–∏—Å–∫–∏ –∏ –æ–±—ä—è—Å–Ω–∏—Ç—å, *–ø–æ—á–µ–º—É* —ç—Ç–æ –ø–ª–æ—Ö–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á–µ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –°–¢–†–û–ì–û —Å–ª–µ–¥—É—é—â–µ–π:

#### üìÑ –ö—Ä–∞—Ç–∫–∞—è —Å—É—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞
[–ó–¥–µ—Å—å –¥–∞–π –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É: –∫—Ç–æ, —á—Ç–æ, –∫–æ–º—É –∏ –Ω–∞ –∫–∞–∫–∏—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö]

---

#### üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ò–°–ö–ò (–ö—Ä–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏)
[–≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª. –¢—ã –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –∏ –æ–ø–∏—Å–∞—Ç—å –≤—Å–µ –ª–æ–≤—É—à–∫–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤. –ò—â–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–µ–µ:]
- –ù–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π –ø–µ—Ä–µ–Ω–æ—Å –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π üõ†Ô∏è: –ò—â–∏ –ø—É–Ω–∫—Ç—ã, –≥–¥–µ –Ω–∞ —Ç–≤–æ–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø—ã—Ç–∞—é—Ç—Å—è –≤–æ–∑–ª–æ–∂–∏—Ç—å –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ –∑–∞–∫–æ–Ω—É (–ì–ö –†–§) –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ –ª–µ–∂–∞—Ç –Ω–∞ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ. –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ –¥–µ–ª–∞—Ç—å –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç.
- –ö–∞–±–∞–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è üí∏: –ù–µ –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞–π —à—Ç—Ä–∞—Ñ. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –ø–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1% –≤ –¥–µ–Ω—å), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–π –∏—Ö –≤ –≥–æ–¥–æ–≤—É—é —Å—Ç–∞–≤–∫—É (1% –≤ –¥–µ–Ω—å = 365% –≥–æ–¥–æ–≤—ã—Ö) –∏ –æ—Ç–º–µ—Ç—å, –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–≥–ª—è–¥–∏—Ç –≥—Ä–∞–±–∏—Ç–µ–ª—å—Å–∫–æ–π.
- –†–∞–∑–º—ã—Ç—ã–µ –∏ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ üßê: –û–±—Ä–∞—â–∞–π –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ ¬´–ø–æ –µ–¥–∏–Ω–æ–ª–∏—á–Ω–æ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é¬ª, ¬´–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª–µ–º¬ª, ¬´—Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç¬ª. –û–±—ä—è—Å–Ω–∏, —á–µ–º —ç—Ç–æ –≥—Ä–æ–∑–∏—Ç.
- –†–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ–º –¥–æ–≥–æ–≤–æ—Ä–∞ üí•: –°—Ä–∞–≤–Ω–∏ —É—Å–ª–æ–≤–∏—è —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è –¥–ª—è –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω. –ï—Å–ª–∏ –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –æ–Ω–∏ –ø—Ä–æ—Å—Ç—ã–µ –∏ –±—ã—Å—Ç—Ä—ã–µ, –∞ –¥–ª—è —Ç–≤–æ–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –¥–æ–ª–≥–∏–µ –∏ —Å –æ–≥—Ä–æ–º–Ω—ã–º–∏ —à—Ç—Ä–∞—Ñ–∞–º–∏, –æ—Ç–º–µ—Ç—å —ç—Ç—É –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å.
- –°–∫—Ä—ã—Ç—ã–µ —Ä–∏—Å–∫–∏ –ø—Ä–∏ –ø—Ä–∏–µ–º–∫–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç–µ üîë: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π, –∫–∞–∫ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ø–æ–º–µ—â–µ–Ω–∏–µ (¬´–±–µ–∑ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤¬ª) –∏ –Ω–∞ –∫–∞–∫–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (—Å—Ä–æ–∫–∏, –∫—Ç–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —É—â–µ—Ä–±).
- –ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –ø—Ä–∞–≤ üö™: –ù–∞–π–¥–∏ –ø—É–Ω–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞—é—Ç –≤—Ç–æ—Ä–æ–π —Å—Ç–æ—Ä–æ–Ω–µ —á—Ä–µ–∑–º–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ—Å—Ç—É–ø –≤ –ø–æ–º–µ—â–µ–Ω–∏–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) –∏–ª–∏ –ª–∏—à–∞—é—Ç —Ç–≤–æ–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∞–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø—Ä–µ—Ç –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É –¥–æ–≥–æ–≤–æ—Ä–∞ —é—Ä–∏—Å—Ç—É).
- –°—Å—ã–ª–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã üìé: –ï—Å–ª–∏ –¥–æ–≥–æ–≤–æ—Ä —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ ¬´–ü—Ä–∞–≤–∏–ª–∞¬ª, ¬´–†–µ–≥–ª–∞–º–µ–Ω—Ç—ã¬ª –∏ —Ç.–ø., –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω—ã –∫ –¥–æ–≥–æ–≤–æ—Ä—É –∏ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è, ‚Äî —ç—Ç–æ –æ–≥—Ä–æ–º–Ω—ã–π —Ä–∏—Å–∫. –£–∫–∞–∂–∏ –Ω–∞ —ç—Ç–æ.

---

#### üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è (–≤ —Ü–∏—Ñ—Ä–∞—Ö)
[–ó–¥–µ—Å—å —á–µ—Ç–∫–æ —Å–æ–±–µ—Ä–∏ –≤—Å–µ, —á—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –¥–µ–Ω–µ–≥: –∞—Ä–µ–Ω–¥–Ω–∞—è –ø–ª–∞—Ç–∞, –æ–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂, –ø–æ—Ä—è–¥–æ–∫ –æ–ø–ª–∞—Ç—ã, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏, —Ä–∞–∑–º–µ—Ä –ø–µ–Ω–µ–π –∏ —à—Ç—Ä–∞—Ñ–æ–≤ –≤ —Ä—É–±–ª—è—Ö, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.]

---

–í–ê–ñ–ù–û: –û—Å–Ω–æ–≤—ã–≤–∞–π—Å—è –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—á–∏—Ç–∞–µ–º, –Ω–∞–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Ñ—Ä–∞–∑—É: "–û–®–ò–ë–ö–ê: –¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–∞–Ω –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞."

–¢–ï–ö–°–¢ –î–û–ö–£–ú–ï–ù–¢–ê:
{document_text}"""
        try:
            response = self.open_router_client.chat.completions.create(
                model=self.generation_model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.0
            )
            answer = response.choices[0].message.content
            token_logger.log_usage(response.usage, self.generation_model, "generate_doc_summary",
                                   f"{document_text=} {answer=}")
            return answer
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–º–º–∞—Ä–∏: {e}")
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–º–º–∞—Ä–∏."