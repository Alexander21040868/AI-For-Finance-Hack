from openai import OpenAI
from token_logger import token_logger
from time_logger import timed
from typing import Optional

class DocumentAnalyzer:
    def __init__(self,
                 open_router_client: OpenAI,
                 generation_model: str,
                 ):
        self.open_router_client = open_router_client
        self.generation_model = generation_model

    @timed
    def generate_summary(self, document_text: Optional[str]) -> str:
        """Генерирует саммари документа с краткой сутью документа и критическими рисками"""
        if document_text is None:
            return "Отсутствует текст документа."
        prompt = f"""Ты — опытный юрист и финансовый консультант с 15-летним стажем, специализирующийся на защите интересов малого бизнеса. Твоя задача — прочитать текст договора и подготовить для предпринимателя краткий, но емкий аналитический отчет в формате Markdown.

Твой отчет должен быть понятен человеку без юридического образования. Твоя главная цель — не просто пересказать пункты, а вскрыть скрытые риски и объяснить, *почему* это плохо для бизнеса.

Структура отчета должна быть СТРОГО следующей:

#### Краткая суть документа
[Здесь дай краткую выжимку: кто, что, кому и на каких основных условиях]

---

#### КРИТИЧЕСКИЕ РИСКИ (Красные флаги)
[Это самый важный раздел. Ты должен найти и описать все ловушки для предпринимателя. Используй эмодзи для акцентов. Ищи и анализируй следующее:]
- Несправедливый перенос обязанностей: Ищи пункты, где на твоего клиента пытаются возложить обязанности, которые по закону (ГК РФ) или стандартной практике лежат на другой стороне. Классический пример: обязанность Арендатора делать капитальный ремонт.
- Кабальные финансовые условия: Не просто указывай штраф. Если видишь пени (например, 1% в день), обязательно пересчитай их в годовую ставку (1% в день = 365% годовых) и отметь, если она выглядит грабительской.
- Размытые и односторонние формулировки: Обращай особое внимание на фразы типа «по единоличному усмотрению», «определяется Арендодателем», «состояние полностью удовлетворяет». Объясни, чем это грозит.
- Риски, связанные с расторжением договора: Сравни условия расторжения для обеих сторон. Если для одной стороны они простые и быстрые, а для твоего клиента — долгие и с огромными штрафами, отметь эту несправедливость.
- Скрытые риски при приемке и возврате: Анализируй, как принимается помещение («без недостатков») и на каких условиях возвращается обеспечительный платеж (сроки, кто оценивает ущерб).
- Потеря контроля и прав: Найди пункты, которые дают второй стороне чрезмерный контроль (например, доступ в помещение в любое время без уведомления) или лишают твоего клиента прав (например, запрет на передачу договора юристу).
- Ссылки на внешние документы: Если договор ссылается на «Правила», «Регламенты» и т.п., которые не приложены к договору и могут меняться, — это огромный риск. Укажи на это.

---

#### Финансовые условия (в цифрах)
[Здесь четко собери все, что касается денег: арендная плата, обеспечительный платеж, порядок оплаты, переменные платежи, размер пеней и штрафов в рублях, если это возможно.]

---

ВАЖНО: Основывайся ИСКЛЮЧИТЕЛЬНО на предоставленном тексте. Не выдумывай информацию. Если текст документа нечитаем, напиши только одну фразу: "ОШИБКА: Текст документа не удалось распознать. Попробуйте загрузить скан лучшего качества."

ТЕКСТ ДОКУМЕНТА:
{document_text}"""
        try:
            response = self.open_router_client.chat.completions.create(
                model=self.generation_model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.0
            )
            answer = response.choices[0].message.content
            token_logger.log_usage(response.usage, self.generation_model, "generate_doc_summary",
                                   f"{document_text=} {answer=}")
            return answer
        except Exception as e:
            print(f"Ошибка при генерации саммари: {e}")
            return "Произошла ошибка при генерации саммари."